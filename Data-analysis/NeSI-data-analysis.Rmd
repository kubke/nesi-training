---
title: "NeSI-data-analysis"
author: "Fabiana"
date: "15 August 2017"
output:
  word_document: 
    fig_caption: yes
  html_document: default
---


```{r setupenv, echo = FALSE, eval = TRUE}

# Set up environment to read files:Need to 
#* set working directory
#* provide correct filename
#* check data has been read as a data.frame

setwd("~/Desktop/GitHub/nesi-training/Data-analysis")
#setwd("~/Documents/GitHub/nesi-training/Data-analysis")

library(ggplot2) #calls ggplot2 which should be installed
library(plyr) #need it for counts
library(reshape2) #need it for plotting
knitr::opts_chunk$set(fig.width=12, fig.height=8) # control figure size in output

```

# Estimating the number of researchers per institution, per discipline

Uses data for 2016 R&D survey (from stats.nz), data from 2012 PBRF, and CRI reporting documents to estimate the size of the workforce. Higher education institutions are tagged as heduni (for universities, under PBRF definition) or hedother, for non-university tertiary institutions that contribute to PBRF. 

## R&D survey 2016
Provides size of research workforce in Government, private business and higher education for years 2014 and 2016 as number of researchers and ftes (resarcher, student researcher, technician and support staff). The data is manually reorganised into rd-2016.csv.

## PBRF data

Uses PBRF reporting data for a list of higher education institutions and total number of funded Evidence Portfolios. The data is manually reorganized into 2 different files: 
(1) researchers-hed.csv which contains all higher education institutions and their respective number of funded eps (by institution)
(2) researchers-discipline.csv which contains all funded eps by the different top level PBRF research disciplines.

## CRI data

Uses CRI data obtained from annual reports to estimate the research workforce in each CRI. The data is very inhomogneous - (data collected in CRI Staff data.xlsx, and numbers 'chosen' from there)

### Sources:
rd-2016-tables.xlsx, tab 7 downloaded from (http://www.stats.govt.nz/browse_for_stats/businesses/research_and_development/info-releases.aspx)
PBRF-2012-Supplement-Appendix-A-Part-1, tabs: Table A-1 and Table A-2 (http://www.tec.govt.nz/funding/funding-and-performance/funding/fund-finder/performance-based-research-fund/previous-quality-evaluation-rounds/)

```{r workforce, echo=FALSE, eval=TRUE}
reshed = read.csv("researchers-hed.csv") #HED institutions
rescri = read.csv("researchers-cris.csv") #CRI data
resdiscipline = read.csv("researchers-discipline.csv")
rdsurvey2016 = read.csv("rd-2016.csv")

#test files

#check it is a dataframe
if (is.data.frame(reshed) != TRUE){
  cat("ERROR: reshed should be in a data frame, but it is not. ")
} 
if (is.data.frame(rescri) != TRUE) {
  cat("ERROR: rescri should be in a data frame, but it is not. ")
} 
if (is.data.frame(resdiscipline) != TRUE) {
  cat("ERROR: resdiscipline should be in a data frame, but it is not")
}
if (is.data.frame(rdsurvey2016) != TRUE) {
  cat("ERROR: rdsurvey2016 should be in a data frame but it is not")
} 

```

## Worforce number in NZ 

As there are no direct numbers of researchers in each higher education institution or discipline, these numbers are estimated using the number of funded EPs in the 2012 PBRF round. The fraction of funded EPs per institution or per discipline is used to calculate the number of researchers from the total number of researchers in higher education provided in the government R&D 2016 survey. The R&D number used here is that under the role 'researcher', i.e., excludes technical staff, students, and support staff.

ASSUMPTION: that the fraction of funded EPs across institutions and across disciplines is based on similar fractions of total PBRF eligible workforce. 

The number of total tech/FTE in Higher Ed is estimated using the same same approach as above.

ASSUMPTION: That the number of technical staff in each institution/discipline is proportional to the number of 'researcher' staff within institution. (this is probably unlikely?)

The total number of technicians in CRIs is calculated from the total number of CRI staff (from government CRI review document) and the total number of technical staff (from the 2016 R&D survey).

ASSUMPTION: that the proportion of staff in different roles is similar in all CRIs. 

According to TEC there are 9 universities and a number of other HED institutions that contribute to the PBRF 2012. All these other HED institutions are grouped into one as "all other". 


```{r researchers, echo=FALSE, eval = TRUE}

#read from rd-2016.csv total eft and number of researchers (exculde student researcher)
#read from rd-2016.csv total eft and number of researchers

#HED numbers
hed.researcher.number <- as.numeric(rdsurvey2016$hed.number.2016[rdsurvey2016$role == "researcher"])
hed.researcher.fte <-as.numeric(rdsurvey2016$hed.fte.2016[rdsurvey2016$role == "researcher"])
hed.tech.number<-as.numeric(rdsurvey2016$hed.number.2016[rdsurvey2016$role == "technician"])
hed.tech.fte<-as.numeric(rdsurvey2016$hed.fte.2016[rdsurvey2016$role == "technician"])

#gov numbers
gov.tech.number<-as.numeric(rdsurvey2016$gov.number.2016[rdsurvey2016$role == "technician"])
gov.tech.fte<-as.numeric(rdsurvey2016$gov.fte.2016[rdsurvey2016$role == "technician"])
gov.res.number <- as.numeric(rdsurvey2016$gov.number.2016[rdsurvey2016$role == "researcher"])
gov.res.fte <- as.numeric(rdsurvey2016$gov.fte.2016[rdsurvey2016$role == "researcher"])

#split Universities from other tertiary institutions, then add other tertiary as a single line

resheduni = subset(reshed, reshed$inst.category == "heduni")
reshedother = subset(reshed, reshed$inst.category == "hedother")

#Test all lines have been read
if (nrow(reshed) != (nrow(resheduni) + nrow(reshedother))) {
  cat("ERROR: didn't split HED files properly")
}

# create a new data frame that contains all universities plus all other HED in a single line, add numbers from all other hed institutions and put into a new line in reshedall

reshedall<-as.data.frame(resheduni)
reshedall[nrow(resheduni) + 1,] = NA #create a new line with NAs
levels(reshedall$institution) <- c(levels(reshedall$institution),"allother") #need to create a new level
reshedall$institution[nrow(reshedall)]<-"allother"
reshedall$inst.category[nrow(reshedall)]<-"hedother"
reshedall$funded.ep[reshedall$institution=="allother"] <-sum(reshedother$funded.ep)
reshedall$student.fte[reshedall$institution=="allother"] <- sum(reshedother$student.fte)
reshedall$student.number[reshedall$institution =="allother"] <- sum(reshedother$student.number)

#Replace NA with 0 - not a good idea -but was unable to deal with NAs

reshedother[is.na(reshedother)] <- 0
reshedall[is.na(reshedall)] <- 0
rescri[is.na(rescri)]<-0
resdiscipline[is.na(resdiscipline)] <- 0

#calculate total researchers per institution from funded eviedence porfolio numbers

total.eps <-sum(reshedall$funded.ep) #total number of funded eps should be 6311.41
if (total.eps != 6311.41) {
  cat("ERROR: you don't have the right number of EPs in ")
}

reshedall$percent.funded.ep <- reshedall$funded.ep * 100 /total.eps
reshedall$res.staff.number <- reshedall$percent.funded.ep * hed.researcher.number  /100
reshedall$res.staff.fte <- reshedall$percent.funded.ep * hed.researcher.fte /100
reshedall$tech.number <- reshedall$percent.funded.ep * hed.tech.number /100
reshedall$tech.fte <- reshedall$percent.funded.ep * hed.tech.fte /100

#caclulate total researchers per discipline from funded eviedence porfolio numbers

cat("There is no tech number per discipline. The number of techs per discipline in HED is calculated from percentage funded EPs and the R&D 2016 survey total number of technicians in the resarch workforce")


resdiscipline$percent.funded.ep <- resdiscipline$funded.ep * 100 /total.eps
resdiscipline$res.staff.number <- resdiscipline$percent.funded.ep * hed.researcher.number  /100
resdiscipline$res.staff.fte <- resdiscipline$percent.funded.ep * hed.researcher.fte /100
resdiscipline$tech.number <- as.numeric(resdiscipline$percent.funded.ep * hed.tech.number /100)
resdiscipline$tech.fte <- resdiscipline$percent.funded.ep * hed.tech.fte /100

#student numbers

# from R&D 2016
hed.student.number <- as.numeric(rdsurvey2016$hed.number.2016[rdsurvey2016$role == "student.researcher"])
hed.student.fte<-as.numeric(rdsurvey2016$hed.fte.2016[rdsurvey2016$role == "student.researcher"])

#From enrollments 2015 - includes all MSc and PhD - not all of them (esp. MSc) would be involved in research
hed.student.enrolled = sum(reshedall$student.number)

cat("According to 2016 R&D survey, there are ", hed.student.number, "student researchers. According to enrolment numbers there are ", hed.student.enrolled, "in MSc + PhD. The discrepancy may be because probably not all MSc students would be necessarily involved in research. For the calculation of total workforce (students + researchers + technicians) I am using the total number of enrolled students. This means I am probably overestimating the size of the total workforce.")

#Add students, researchers and techs to total column

resdiscipline$total.number <- resdiscipline$res.staff.number + resdiscipline$student.number + resdiscipline$tech.number
resdiscipline$total.fte <- resdiscipline$res.staff.fte + resdiscipline$student.fte + resdiscipline$tech.fte
reshedall$total.number <- reshedall$res.staff.number + reshedall$student.number + reshedall$tech.number
reshedall$total.fte <- reshedall$res.staff.fte + reshedall$student.fte + reshedall$tech.fte
```


```{r learners, echo=FALSE, eval = TRUE}

#Calculate total number of NeSI learners per institution 

#add different years of NeSi learners to new totals column
reshedall$nesi.learner.total = reshedall$nesi.learner.2017 + reshedall$nesi.learner.2016 + reshedall$nesi.learner.2015 +reshedall$nesi.learner.2013

rescri$nesi.learner.total = rescri$nesi.learner.2017+rescri$nesi.learner.2016+rescri$nesi.learner.2015+rescri$nesi.learner.2013

#Calculate the proportion of number of Nesi learners per institution
#proportion =  nesi total *100/ total workforce (student, researchers and tech)
reshedall$nesi.learner.proportion = reshedall$nesi.learner.total * 100 / reshedall$total.number
rescri$nesi.learner.proportion = rescri$nesi.learner.total *100 / rescri$total.number

```

## Distribution of NeSi learners across institutions (total and per year)

ASSUMPTION: that learners are all different people, i.e., does not consider the possibility that the same person may have attended more than one event. 

```{r plot learners, echo=FALSE, eval = TRUE}

#Plots learners by institution (total and per year) separating HED and CRIs

cat("Distribution of NeSi learners by HED institutions (all years) ")

ggplot(reshedall, aes(x=reorder(institution, nesi.learner.total), y=nesi.learner.total)) +
  geom_bar(stat="identity") + 
  #ggtitle("# NeSI Learners by institution (HED)")+
  ylab("Total number of learners")+
  xlab("")+
  coord_flip()

cat("Distribution of NeSI learners by HED institutions (broken by years)")

hedperyear <- melt(reshedall[,c('institution','nesi.learner.2013','nesi.learner.2015','nesi.learner.2016','nesi.learner.2017')],id.vars = 1)
ggplot(hedperyear,aes(x = institution,y = value)) + 
  geom_bar(aes(fill = variable),stat = "identity",position = "dodge")  +
  ylab("number of learners") +
  xlab("")+
  coord_flip()

cat("Distribution of NeSI learners by CRIs (all years)")

ggplot(rescri, aes(x=reorder(institution,nesi.learner.total), y=nesi.learner.total)) +
  geom_bar(stat="identity") + 
  ylab("Total number of learners")+
  xlab("")+
  coord_flip()
  
cat("Distribution of NeSI learners by CRI (broken by years)")

criperyear <- melt(rescri[,c('institution','nesi.learner.2013','nesi.learner.2015','nesi.learner.2016','nesi.learner.2017')],id.vars = 1)
ggplot(criperyear,aes(x = institution,y = value)) + 
  geom_bar(aes(fill = variable),stat = "identity",position = "dodge")  +
  ylab("number of learners") +
  xlab("")+
  coord_flip()

```

## NeSI learners as a proportion of workforce

Since I am using all enrolled students as part of the calculation of total researhc workforce, these plots underestimate the proportion of the workforce that was engaged in NeSI learning. 

ASSUMPTION: that learners are all different people, i.e., does not consider the possibility that the same person may have attended more than one event. 

```{r learner proportion, echo=FALSE, eval=TRUE}
cat("Proportion of NeSi learners by HED institutions (all years) ")

ggplot(reshedall, aes(x=reorder(institution,nesi.learner.proportion), y=nesi.learner.proportion)) +
  geom_bar(stat="identity") + 
  #ggtitle("# NeSI Learners % by institution (HED)")+
  ylab("% of workforce")+
  xlab("")+
  coord_flip()

cat("Distribution of % NeSI learners by CRIs (all years)")

rescrionly = subset(rescri, rescri$inst.category == "cri")
ggplot(rescrionly, aes(x=reorder(institution,nesi.learner.proportion), y=nesi.learner.proportion)) +
  geom_bar(stat="identity") + 
  ylab("Total number of learners")+
  xlab("")+
  coord_flip()

```


##Proportion of the workforce in different disciplines that use NeSI

I used the numbers displayed in the bubble plot from the NeSI 2016 report, and reorganize the discipline used in that plot to fit the PBRF disciplines (which are used to calculate the workforce per discipline). The workforce size is probably an overestimate as I am using number of enrolled MSasters and PhD students. 

```{r user proportion, echo=FALSE, eval=TRUE}

#calculate percent of nesi users per total estimated workforce
# number nesi users *100 / total workforce

#NeSI users by discipline

discipline.nesi.users = sum(resdiscipline$nesi.users) 
discipline.res.number = sum(resdiscipline$res.staff.number) + sum(resdiscipline$student.number) + sum(resdiscipline$tech.number)

#total research workforce (per rd 2016) - No info about discipline
#Need to recalculate this .....

res.gov.2016 = gov.res.number + gov.tech.number
res.hed.2016 = hed.researcher.number + hed.student.number + hed.tech.number
hed.gov.2016 = res.gov.2016 + res.hed.2016 #HED + Government total users


percent.nesi.users.gov.hed = discipline.nesi.users * 100 / hed.gov.2016
percentage.nesi.users = discipline.nesi.users *100 /discipline.res.number
resdiscipline$nesi.percentage = resdiscipline$nesi.users * 100 / resdiscipline$total.number

cat("There are", hed.gov.2016, "researchers in higer education and government combined, and ", discipline.nesi.users, "total nesi users. That is, NeSi users are about ", format(percent.nesi.users.gov.hed, digits = 3, nsmall =2),"% of the gov + HED workforce. The workforce for business has been excluded from the calculation. This includes support staff - so perhaps I should remove this.") 

cat("A calculation of the percentage of the workforce by discipline cannot be done with the avilable data - but it can be calculated assuming all nesi users are in HED - this provides an overestimate of the percentage of workforce within the discipline that is using NeSI. ")

ggplot(resdiscipline, aes(x=reorder(discipline,nesi.percentage), y=nesi.percentage)) +
  geom_bar(stat="identity") + 
  xlab("") +
  ylab("users as percentage of workforce")+
  ggtitle("% of workforce using NeSI, by discipline")+
  coord_flip()

```

This is, however, an overestimation of the actual proportions since it assumes all NeSI users come from the HED sector. I am unable to find a breakdown of research force within CRIs that I can map onto disciplines. The only way around this would be to assume that the distribution across disciplines in the government and higher education are the same and break up the government data across those proportions - but this would probably be a really incorrect assumption. I should be able to sort this once I have the raw nesi usage data. 

# NeSI training activities

```{r training sessions, echo = FALSE, eval = TRUE}

#read all nesi training events and separate into outreach and other types of training.
nesi.training.all = read.csv("nesi-training.csv", dec = ",")
nesi.training.all$year = as.numeric(levels(nesi.training.all$year))[nesi.training.all$year]
#nesi.training.all$event.number <- as.factor(nesi.training.all$event.number) # I need this column to be a factor

nesi.outreach = subset(nesi.training.all, nesi.training.all$purpose == "outreach")
nesi.training = subset(nesi.training.all, nesi.training.all$purpose != "outreach")

all.training.events <- unique(nesi.training.all$event.number)
outreach.events <- unique(nesi.outreach$event.number)
training.events <- unique(nesi.training$event.number)

cat("There were ", length(all.training.events), "events; of these" , length(outreach.events), "were outreach events and ", length(training.events), "were training events.")
```


```{r training events by institution, echo = FALSE, EVAL = TRUE}

# Training events by institution

#This below lets me do bar graphs, but I need to manangle the data on excel, and redo every time I update the main spreadsheet - so not sure this is a good idea. Also I would have to do a new spreadsheet every time I try to susbset something - too much risk for errors.

#training.institution = read.csv("nesi-training-by-institution.csv")
#training.institution_m<- melt(training.institution, id.vars = "institution")
#ggplot(training.institution_m, aes(x = variable, y = value, )) + geom_bar(stat = "identity") +
 # facet_wrap(~institution) +
 # coord_flip() +
 # theme(axis.text.y = element_text(size = 3))
  
#This counts the number of occurrences of combinations of institution/events as a bubble graph. 
#cri.training 

# plot training for cris and other (mainly govt?)
ggplot(subset(nesi.training.all, institution.type %in% c("cri", "self")), aes(x=institution, y=event.type, color = ..n.., size = ..n..)) +
  scale_color_gradient(low="blue", high="red")+
  guides(color = 'legend') +
  geom_count() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Training participation by CRIs and NeSI")+
  coord_flip()

ggplot(subset(nesi.training.all, institution.type %in% c("other", "?")), aes(x=institution, y=event.type, color = ..n.., size = ..n..)) +
  scale_color_gradient(low="blue", high="red")+
  guides(color = 'legend') +
  geom_count() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Training participation by other government(?) institutions")+
  coord_flip()

 #I dont know how to get the legend to show only integers in plot above
  
# plot training for higher ed
ggplot(subset(nesi.training.all, institution.type %in% c("heduni")), aes(x=institution, y=event.type, color = ..n.., size = ..n..)) +
  geom_count() +
  scale_color_gradient(low="blue", high="red")+
  guides(color = 'legend') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Training participation by Higer Education institutions")+
  coord_flip()
 
  
```

#NeSI usage

```{r nesi usage test, echo = FALSE, eval = FALSE}
nesi.use.test = read.csv("nesi-mfk-testdata.csv")
nesi.use.test$used = as.numeric(nesi.use.test$used)

#trying to see if I can do a count plot

ggplot(subset(nesi.use.test, (project_reporting_discipline != "0.00")), aes(x=institution, y=project_reporting_discipline, type, color = ..n.., size = ..n..)) +
  geom_count(alpha=0.5) +
  scale_color_gradient(low="blue", high="red")+
  guides(color = 'legend') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "This is a NeSI user chart")+
  coord_flip()

ggplot(subset(nesi.use.test, used %in% c(90:1000)), aes(x=institution, y=project_reporting_discipline, type, color = ..n.., size = ..n..)) +
  geom_count(alpha=0.5) +
  scale_color_gradient(low="blue", high="red")+
  guides(color = 'legend') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "This is a NeSI user chart")+
  coord_flip()
```
```{r nesi use create files, echo=FALSE, eval=TRUE}

#read nesi usage data
nesi.use = read.csv("nesi-mfk-testdata-trimmed.csv")

#create destination file
bubble.plot <- as.data.frame(unique(as.character(nesi.use$project_reporting_discipline)))
colnames(bubble.plot)<-"discipline"


#for unknown

for (i in 2009:2018){
   
   yearcolumn<-paste("nesi.use$X",i , sep="")
   temp <- subset(nesi.use, (eval(parse(text = yearcolumn))== "y"))
   
   #get number of researchers
   bubble.plot$users[bubble.plot$discipline == "unknown"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "unknown"])) 
   bubble.plot$users[bubble.plot$discipline == "Astronomy"]<-
     length(unique(temp$id[temp$project_reporting_discipline == "Astronomy"])) 
   bubble.plot$users[bubble.plot$discipline == "Biology"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Biology"]))
   bubble.plot$users[bubble.plot$discipline == "Chemistry"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Chemistry"]))
   bubble.plot$users[bubble.plot$discipline == "Computer Science"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Computer Science"]))
   bubble.plot$users[bubble.plot$discipline == "Earth Science"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Earth Science"]))
   bubble.plot$users[bubble.plot$discipline == "Engineering"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Engineering"]))
   bubble.plot$users[bubble.plot$discipline == "Mathematics"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Mathematics"]))
   bubble.plot$users[bubble.plot$discipline == "Medical Science"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Medical Science"]))
   bubble.plot$users[bubble.plot$discipline == "Physics"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Physics"]))
   bubble.plot$users[bubble.plot$discipline == "Social Science"]<- 
     length(unique(temp$id[temp$project_reporting_discipline == "Social Science"]))
   
   colnames(bubble.plot)[colnames(bubble.plot) == 'users'] <- paste("users.", i, sep="")
  
   #get number of projects
   bubble.plot$projects[bubble.plot$discipline == "unknown"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "unknown"]))
   bubble.plot$projects[bubble.plot$discipline == "Astronomy"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Astronomy"]))
   bubble.plot$projects[bubble.plot$discipline == "Biology"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Biology"])) 
   bubble.plot$projects[bubble.plot$discipline == "Chemistry"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Chemistry"]))
   bubble.plot$projects[bubble.plot$discipline == "Computer Science"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Computer Science"]))
   bubble.plot$projects[bubble.plot$discipline == "Earth Science"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Earth Science"]))
   bubble.plot$projects[bubble.plot$discipline == "Engineering"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Engineering"]))
   bubble.plot$projects[bubble.plot$discipline == "Mathematics"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Engineering"]))
   bubble.plot$projects[bubble.plot$discipline == "Medical Science"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Medical Science"])) 
   bubble.plot$projects[bubble.plot$discipline == "Physics"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Physics"]))
   bubble.plot$projects[bubble.plot$discipline == "Social Science"]<- 
     length(unique(temp$project_id[temp$project_reporting_discipline == "Social Science"])) 
   
   colnames(bubble.plot)[colnames(bubble.plot) == 'projects'] <- paste("projects.", i, sep="")
  
   #get number of used hours
   bubble.plot$hours[bubble.plot$discipline == "unknown"]<- 
     sum(temp$used[temp$project_reporting_discipline == "unknown"])
   bubble.plot$hours[bubble.plot$discipline == "Astronomy"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Astronomy"])
   bubble.plot$hours[bubble.plot$discipline == "Biology"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Biology"])
   bubble.plot$hours[bubble.plot$discipline == "Chemistry"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Chemistry"])
   bubble.plot$hours[bubble.plot$discipline == "Computer Science"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Computer Science"])
   bubble.plot$hours[bubble.plot$discipline == "Earth Science"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Earth Science"])
   bubble.plot$hours[bubble.plot$discipline == "Engineering"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Engineering"])
   bubble.plot$hours[bubble.plot$discipline == "Mathematics"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Mathematics"])
   bubble.plot$hours[bubble.plot$discipline == "Medical Science"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Medical Science"])
   bubble.plot$hours[bubble.plot$discipline == "Physics"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Engineering"])
   bubble.plot$hours[bubble.plot$discipline == "Social Science"]<- 
     sum(temp$used[temp$project_reporting_discipline == "Social Science"])
   
   colnames(bubble.plot)[colnames(bubble.plot) == 'hours'] <- paste("hours.", i, sep="")
}

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "unknown"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "unknown"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "unknown"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "unknown"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "unknown"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "unknown"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("unknown")


ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Astronomy"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Astronomy"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Astronomy"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Astronomy"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Astronomy"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Astronomy"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Astronomy")

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Biology"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Biology"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Biology"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Biology"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Biology"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Biology"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Biology")

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Chemistry"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Chemistry"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Chemistry"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Chemistry"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Chemistry"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Chemistry"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Chemistry")


ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Computer Science"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Computer Science"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Computer Science"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Computer Science"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Computer Science"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Computer Science"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Computer Science")

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Earth Science"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Earth Science"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Earth Science"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Earth Science"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Earth Science"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Earth Science"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Earth Science")

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Engineering"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Engineering"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Engineering"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Engineering"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Engineering"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Engineering"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Engineering")

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Mathematics"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Mathematics"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Mathematics"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Mathematics"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Mathematics"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Mathematics"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Mathematics")

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Medical Science"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Medical Science"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Medical Science"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Medical Science"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Medical Science"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Medical Science"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Medical Science")

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Physics"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Physics"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Physics"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Physics"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Physics"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Physics"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Physics")

ggplot()+
  geom_point(data=subset(bubble.plot, discipline == "Social Science"), aes(x=projects.2017, y=hours.2017, size = users.2017, colour = "2017"))+
  geom_point(data=subset(bubble.plot, discipline == "Social Science"), aes(x=projects.2016, y=hours.2016, size = users.2016, colour="2016"))+
  geom_point(data=subset(bubble.plot, discipline == "Social Science"), aes(x=projects.2015, y=hours.2015, size = users.2015,colour = "2015" ))+
  geom_point(data=subset(bubble.plot, discipline == "Social Science"), aes(x=projects.2014, y=hours.2014, size = users.2014,colour = "2014" ))+
   geom_point(data=subset(bubble.plot, discipline == "Social Science"), aes(x=projects.2013, y=hours.2013, size = users.2013,colour = "2013" ))+
   geom_point(data=subset(bubble.plot, discipline == "Social Science"), aes(x=projects.2012, y=hours.2012, size = users.2012,colour = "2012" ))+
  ggtitle("Social Science")

```





```{r sandbox, echo=FALSE, eval=FALSE}

# entering filenames into for loops

year = 2015
discipline = dQuote("unknown")

for (i in 2009:20018){
    bubble.plot[paste("user.", i, sep="")] <- NA
}

column <- paste("bubble.plot$users.", year,"[bubble.plot$discipline ==",discipline,"]",sep="")
eval(parse(text=column)) = 3000
bubble.plot$users.2014[bubble.plot$discipline == “unknown”] = 300 

  bubble.plot <- as.data.frame(unique(as.character(nesi.use$project_reporting_discipline)))
colnames(bubble.plot)<-"discipline"

year=2014
    column <- paste("bubble.plot$users.", as.character(year),"[bubble.plot$discipline ==",discipline,"]", sep="")
  eval(parse(text=column)) <-2056

for (year in c(2009:2018)){
  year=2014
  i=2
  column <- paste("bubble.plot$users", year,"[bubble.plot$discipline ==",dQuote("unknown"),"]", sep="")
  eval(parse(text=column)) <-2056
}
    length(unique(nesi.use.year$id[nesi.use.year$project_reporting_discipline == "unknown"]))

#Donut plot
# Create data to plot
dat <- data.frame(institution = resinstitution$institution, staffnumber = resinstitution$res.staff.number, insttype = resinstitution$inst.category)

# Add addition columns, needed for drawing with geom_rect.
dat$fraction = dat$staffnumber[dat$insttype=="heduni"] / sum(dat$staffnumber[dat$insttype=="heduni"])
dat = dat[order(dat$fraction[dat$insttype=="heduni"]), ]
dat$ymax = cumsum(dat$fraction[dat$insttype=="heduni"])
dat$ymin = c(0, head(dat$ymax[dat$insttype=="heduni"], n=-1))
 
# Make the plot
p2 = ggplot(dat, aes(fill=institution, ymax=ymax, ymin=ymin, xmax=4, xmin=3)) +
     geom_rect(colour="grey30") +
     coord_polar(theta="y") +
     xlim(c(0, 4)) +
     theme_bw() +
     theme(panel.grid=element_blank()) +
     theme(axis.text=element_blank()) +
     theme(axis.ticks=element_blank()) +
     ggtitle("proportion of research staff at universities") 
p2
```

